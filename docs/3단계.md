# 3단계: API Gateway 구현

## 요구사항

### 기본 설정
- **포트**: `8080`
- **게이트웨이**: Spring Cloud Gateway
- **Base URL**: `/api`
- **로드밸런싱**: Round Robin (기본값)

### 프로젝트 구조
```
gateway-service/
├── src/main/java/
│   └── com/example/gateway/
│       ├── GatewayApplication.java
│       ├── config/
│       │   └── GatewayConfig.java
│       └── filter/
│           └── LoggingFilter.java
├── src/main/resources/
│   └── application.yml
├── build.gradle
└── settings.gradle
```

### 의존성 설정
`build.gradle`에 추가해야 할 주요 의존성:
```gradle
dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-gateway'
    implementation 'org.springframework.cloud:spring-cloud-starter-loadbalancer'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2023.0.0"
    }
}
```

### 라우팅 규칙
구현해야 할 서비스별 라우팅:

| 서비스 | 원본 URL | 게이트웨이 URL | 대상 포트 |
|--------|----------|----------------|-----------|
| Product Service | `localhost:8082/api/products/**` | `localhost:8080/api/products/**` | 8082 |
| Order Service | `localhost:8083/api/orders/**` | `localhost:8080/api/orders/**` | 8083 |

### 설정 파일 (application.yml)
```yaml
server:
  port: 8080

spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      routes:
        - id: product-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/products/**
          filters:
            - StripPrefix=0
            
        - id: order-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/orders/**
          filters:
            - StripPrefix=0

logging:
  level:
    org.springframework.cloud.gateway: DEBUG
```

### 커스텀 필터 구현
다음 기능을 가진 글로벌 필터 구현:

#### 1. 요청 로깅 필터
- 모든 요청의 URI, Method, Headers 로깅
- 응답 시간 측정 및 로깅
- 응답 상태 코드 로깅

#### 2. CORS 설정
- 모든 Origin 허용 (개발환경)
- GET, POST, PUT, DELETE, OPTIONS 메서드 허용
- Content-Type, Authorization 헤더 허용

### API 테스트 시나리오

#### 1. 기본 라우팅 테스트
```bash
# Product Service 테스트
curl -X GET http://localhost:8080/api/products
curl -X GET http://localhost:8080/api/products/1

# Order Service 테스트  
curl -X GET http://localhost:8080/api/orders
curl -X POST http://localhost:8080/api/orders \
  -H "Content-Type: application/json" \
  -d '{"productId": 1, "quantity": 2}'
```

#### 2. 통합 워크플로우 테스트
1. **상품 조회**: `GET /api/products/1`
2. **주문 생성**: `POST /api/orders` (위에서 조회한 상품으로)
3. **주문 조회**: `GET /api/orders/{id}`
4. **주문 취소**: `PUT /api/orders/{id}/cancel`

### 헬스체크 및 모니터링

#### Actuator 설정
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health, info, gateway
  endpoint:
    health:
      show-details: always
```

#### 게이트웨이 상태 확인
- **헬스체크**: `GET /actuator/health`
- **라우트 정보**: `GET /actuator/gateway/routes`
- **게이트웨이 필터**: `GET /actuator/gateway/globalfilters`

### 부하 분산 테스트

#### 1. 동일 서비스 다중 인스턴스 실행
```bash
# Product Service를 다른 포트로 실행
./gradlew bootRun --args='--server.port=8082' &
./gradlew bootRun --args='--server.port=8084' &

# Order Service를 다른 포트로 실행  
./gradlew bootRun --args='--server.port=8083' &
./gradlew bootRun --args='--server.port=8085' &
```

#### 2. 로드밸런싱 설정 (고급)
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: product-service-lb
          uri: lb://product-service
          predicates:
            - Path=/api/products/**
    loadbalancer:
      ribbon:
        enabled: false
```

### 오류 처리 및 예외 상황

#### 1. 서비스 다운 시나리오
- Product Service(8082) 중단 후 게이트웨이 요청 테스트
- 적절한 5xx 에러 응답 확인

#### 2. 타임아웃 설정
```yaml
spring:
  cloud:
    gateway:
      httpclient:
        connect-timeout: 1000
        response-timeout: 5000
```

### 완료 기준
- ✅ 게이트웨이가 8080 포트에서 정상 실행
- ✅ Product Service와 Order Service 라우팅 동작
- ✅ 요청 로깅 필터가 정상 작동
- ✅ CORS 설정이 적용되어 브라우저에서 접근 가능
- ✅ 헬스체크 엔드포인트 정상 동작
- ✅ 통합 워크플로우 테스트 통과
- ✅ 서비스 다운 시 적절한 에러 응답

### 고급 기능 (선택사항)
- [ ] JWT 인증 필터 구현
- [ ] Rate Limiting 적용
- [ ] Circuit Breaker 패턴 구현
- [ ] 메트릭 수집 및 모니터링 대시보드

---

**힌트**:
- Spring Cloud Gateway는 Reactive 기반이므로 WebFlux 사용
- 필터 순서가 중요합니다! `@Order` 어노테이션 활용
- Gradle 멀티모듈 프로젝트 구성 시 `settings.gradle`에 모든 모듈 포함
- `./gradlew bootRun`으로 개발 시 빠른 테스트 가능

준비되면 시작해보세요! 🚀